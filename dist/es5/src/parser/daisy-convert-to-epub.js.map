{"version":3,"file":"daisy-convert-to-epub.js","sourceRoot":"","sources":["../../../../src/parser/daisy-convert-to-epub.ts"],"names":[],"mappings":"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","sourcesContent":["// ==LICENSE-BEGIN==\n// Copyright 2017 European Digital Reading Lab. All rights reserved.\n// Licensed to the Readium Foundation under one or more contributor license agreements.\n// Use of this source code is governed by a BSD-style license\n// that can be found in the LICENSE file exposed on Github (readium) in the project repository.\n// ==LICENSE-END==\n\nimport * as debug_ from \"debug\";\nimport * as fs from \"fs\";\nimport * as path from \"path\";\nimport * as xmldom from \"xmldom\";\nimport * as xpath from \"xpath\";\nimport { ZipFile } from \"yazl\";\n\nimport { MediaOverlayNode } from \"@models/media-overlay\";\nimport { Metadata } from \"@models/metadata\";\nimport { Properties } from \"@models/metadata-properties\";\nimport { Publication } from \"@models/publication\";\nimport { Link } from \"@models/publication-link\";\nimport { TaJsonDeserialize, TaJsonSerialize } from \"@r2-lcp-js/serializable\";\nimport { IZip } from \"@r2-utils-js/_utils/zip/zip\";\n\nimport { lazyLoadMediaOverlays } from \"./epub\";\nimport { loadFileBufferFromZipPath, loadFileStrFromZipPath } from \"./epub-daisy-common\";\n\nconst debug = debug_(\"r2:shared#parser/daisy-convert-to-epub\");\n\nfunction ensureDirs(fspath: string) {\n    const dirname = path.dirname(fspath);\n\n    if (!fs.existsSync(dirname)) {\n        ensureDirs(dirname);\n        fs.mkdirSync(dirname);\n    }\n}\n\n// this function modifies the input parameter \"publication\"!\nexport const convertDaisyToReadiumWebPub = async (\n    outputDirPath: string, publication: Publication): Promise<string | undefined> => {\n\n    return new Promise(async (resolve, reject) => {\n\n        const zipInternal = publication.findFromInternal(\"zip\");\n        if (!zipInternal) {\n            debug(\"No publication zip!?\");\n            return reject(\"No publication zip!?\");\n        }\n        const zip = zipInternal.Value as IZip;\n\n        const outputZipPath = path.join(outputDirPath, \"daisy-to-epub.webpub\");\n        ensureDirs(outputZipPath);\n\n        let timeoutId: NodeJS.Timeout | undefined;\n        const zipfile = new ZipFile();\n        try {\n            const writeStream = fs.createWriteStream(outputZipPath);\n            zipfile.outputStream.pipe(writeStream)\n                .on(\"close\", () => {\n                    debug(\"ZIP close\");\n                    if (timeoutId) {\n                        clearTimeout(timeoutId);\n                        timeoutId = undefined;\n                        resolve(outputZipPath);\n                    }\n                })\n                .on(\"error\", (e: any) => {\n                    debug(\"ZIP error\", e);\n                    reject(e);\n                });\n\n            // <dtbook xmlns=\"http://www.daisy.org/z3986/2005/dtbook/\" ...\n            const select = xpath.useNamespaces({\n                dtbook: \"http://www.daisy.org/z3986/2005/dtbook/\",\n                // epub: \"http://www.idpf.org/2007/ops\",\n                // xhtml: \"http://www.w3.org/1999/xhtml\",\n            });\n\n            const elementNames = [\n                \"address\",\n                \"annoref\",\n                \"annotation\",\n                \"author\",\n                \"bdo\",\n                \"bodymatter\",\n                \"book\",\n                \"bridgehead\",\n                \"byline\",\n                \"caption\",\n                \"cite\",\n                \"col\",\n                \"colgroup\",\n                \"covertitle\",\n                \"dateline\",\n                \"dfn\",\n                \"docauthor\",\n                \"doctitle\",\n                \"dtbook\",\n                \"epigraph\",\n                \"frontmatter\",\n                \"hd\",\n                \"imggroup\",\n                \"kbd\",\n                \"level\",\n                \"levelhd\",\n                \"level1\",\n                \"level2\",\n                \"level3\",\n                \"level4\",\n                \"level5\",\n                \"level6\",\n                \"lic\",\n                \"line\",\n                \"linegroup\",\n                \"linenum\",\n                \"link\",\n                \"list\",\n                \"note\",\n                \"noteref\",\n                \"pagenum\",\n                \"poem\",\n                \"prodnote\",\n                \"rearmatter\",\n                \"samp\",\n                \"sent\",\n                \"sub\",\n                \"sup\",\n                \"q\",\n                \"w\",\n                \"notice\",\n                \"sidebar\",\n                \"blockquote\",\n                \"abbr\",\n                \"acronym\",\n                \"title\",\n            ];\n\n            let combinedMediaOverlays: MediaOverlayNode | undefined;\n\n            const patchMediaOverlaysTextHref = (mo: MediaOverlayNode) => {\n\n                if (mo.Text) {\n                    // TODO: .xml file extension replacement is bit weak / brittle\n                    // (but for most DAISY books, this is a reasonable expectation)\n                    mo.Text = mo.Text.replace(/\\.xml/, \".xhtml\");\n                }\n                if (mo.Children) {\n                    for (const child of mo.Children) {\n                        patchMediaOverlaysTextHref(child);\n                    }\n                }\n            };\n\n            // dtb:multimediaContent ==> audio,text\n            if (publication.Spine &&\n                publication.Metadata?.AdditionalJSON &&\n                publication.Metadata.AdditionalJSON[\"dtb:multimediaType\"] === \"audioFullText\") {\n\n                combinedMediaOverlays = new MediaOverlayNode();\n                combinedMediaOverlays.SmilPathInZip = undefined;\n                combinedMediaOverlays.initialized = true;\n                combinedMediaOverlays.Role = [];\n                combinedMediaOverlays.Role.push(\"section\");\n                combinedMediaOverlays.duration = 0;\n\n                for (const linkItem of publication.Spine) {\n                    if (linkItem.MediaOverlays) {\n\n                        if (!linkItem.MediaOverlays.initialized) {\n                            // mo.initialized true/false is automatically handled\n                            await lazyLoadMediaOverlays(publication, linkItem.MediaOverlays);\n\n                            if (linkItem.MediaOverlays.duration) {\n                                if (!linkItem.Duration) {\n                                    linkItem.Duration = linkItem.MediaOverlays.duration;\n                                }\n                                if (linkItem.Alternate) {\n                                    for (const altLink of linkItem.Alternate) {\n                                        if (altLink.TypeLink === \"application/vnd.syncnarr+json\") {\n                                            if (!altLink.Duration) {\n                                                altLink.Duration = linkItem.MediaOverlays.duration;\n                                            }\n                                        }\n                                    }\n                                }\n                            }\n                        }\n\n                        if (linkItem.MediaOverlays.Children) {\n                            if (!combinedMediaOverlays.Children) {\n                                combinedMediaOverlays.Children = [];\n                            }\n                            combinedMediaOverlays.Children =\n                                combinedMediaOverlays.Children.concat(linkItem.MediaOverlays.Children);\n\n                            if (linkItem.MediaOverlays.duration) {\n                                combinedMediaOverlays.duration += linkItem.MediaOverlays.duration;\n                            }\n                        }\n                    }\n                }\n\n                patchMediaOverlaysTextHref(combinedMediaOverlays);\n            }\n            publication.Spine = [];\n\n            const resourcesToKeep: Link[] = [];\n\n            // reference copy! (not by value) so we can publication.Resources.push(...) safely within the loop\n            // const resources = [...publication.Resources];\n            // ... but we completely replace the array of Links, so this is fine:\n            for (const resLink of publication.Resources) {\n                // relative to publication root (package.opf / ReadiumWebPubManifest.json)\n                if (!resLink.HrefDecoded) {\n                    continue;\n                }\n                if (resLink.TypeLink === \"text/css\" || resLink.HrefDecoded.endsWith(\".css\")) {\n\n                    let cssText = await loadFileStrFromZipPath(resLink.Href, resLink.HrefDecoded, zip);\n                    if (!cssText) {\n                        debug(\"!loadFileStrFromZipPath\", resLink.HrefDecoded);\n                        continue;\n                    }\n\n                    // replace comments\n                    cssText = cssText.replace(/\\/\\*([\\s\\S]+?)\\*\\//gm, (_match, p1, _offset, _string) => {\n                        const base64 = Buffer.from(p1).toString(\"base64\");\n                        return `/*__${base64}__*/`;\n                    });\n\n                    // const regex = new RegExp(`[^#\\.](${elementNames.join(\"|\")})`, \"g\");\n                    for (const elementName of elementNames) {\n                        // meant to patch CSS selectors, but not property values\n                        const regex = new RegExp(\n                            `([^#\\.a-zA-Z0-9\\-_])(${elementName})([^a-zA-Z0-9\\-_;])`, \"g\");\n                        // let i = -1;\n                        // let match: RegExpExecArray | null;\n                        // // tslint:disable-next-line: no-conditional-assignment\n                        // while (match = regex.exec(cssText)) {\n                        //     i++;\n                        //     debug(\"A -----------\");\n                        //     debug(i, elementName, `$_$_$${match[0]}$_$_$`,\n                        // `===${match[1]}^^^${match[2]}^^^${match[3]}===`);\n                        //     debug(\"B -----------\");\n                        // }\n                        cssText = cssText.replace(regex, `$1.$2_R2$3`);\n\n                        // second pass, as the first doesn't match tokens with trailing / leading separators\n                        cssText = cssText.replace(regex, `$1.$2_R2$3`);\n                    }\n\n                    // restore comments\n                    cssText = cssText.replace(/\\/\\*__([\\s\\S]+?)__\\*\\//g, (_match, p1, _offset, _string) => {\n                        const comment = Buffer.from(p1, \"base64\").toString(\"utf8\");\n                        return `/*${comment}*/`;\n                    });\n\n                    // const newCssFilePath = resLink.HrefDecoded.replace(/\\.css$/, \"__.css\");\n                    // const cssOutputFilePath = path.join(outputDirPathExploded, newCssFilePath);\n                    // ensureDirs(cssOutputFilePath);\n                    // fs.writeFileSync(cssOutputFilePath, cssText);\n                    zipfile.addBuffer(Buffer.from(cssText), resLink.HrefDecoded);\n\n                    // const resLinkJson = TaJsonSerialize(resLink);\n                    // // resLinkJson.href = newCssFilePath;\n                    // const resLinkClone = TaJsonDeserialize<Link>(resLinkJson, Link);\n                    // resLinkClone.setHrefDecoded(newCssFilePath);\n\n                    resourcesToKeep.push(resLink);\n\n                } else if (resLink.TypeLink === \"application/x-dtbook+xml\" || resLink.HrefDecoded.endsWith(\".xml\")) {\n\n                    const dtBookStr = await loadFileStrFromZipPath(resLink.Href, resLink.HrefDecoded, zip);\n                    if (!dtBookStr) {\n                        debug(\"!loadFileStrFromZipPath\", dtBookStr);\n                        continue;\n                    }\n                    const dtBookDoc = new xmldom.DOMParser().parseFromString(dtBookStr, \"application/xml\");\n\n                    const title = dtBookDoc.getElementsByTagName(\"doctitle\")[0]?.textContent;\n\n                    const listElements = dtBookDoc.getElementsByTagName(\"list\");\n                    for (let i = 0; i < listElements.length; i++) {\n                        const listElement = listElements.item(i);\n                        if (!listElement) {\n                            continue;\n                        }\n                        const type = listElement.getAttribute(\"type\");\n                        if (type) {\n                            // TODO: strictly-speaking, this is a read-only property!\n                            (listElement as any).tagName = type;\n                            // listElement.removeAttribute(\"type\");\n                        }\n                    }\n\n                    //             .replace(/(<\\/?)imggroup/g, \"$1figure\")\n                    //             .replace(/<caption/g, \"<figcaption\")\n                    //             .replace(/<\\/caption>/g, \"</figcaption>\");\n\n                    for (const elementName of elementNames) {\n                        // getElementsByName(elementName: string): NodeListOf<HTMLElement>\n                        // ==> not available in the XMLDOM API\n                        // getElementsByTagName(qualifiedName: string): HTMLCollectionOf<Element>\n                        // ==> mutates during loop because of tagName reassignment!\n                        const els = Array.from(dtBookDoc.getElementsByTagName(elementName)).filter((el) => el);\n                        for (const el of els) {\n                            el.setAttribute(\"data-dtbook\", elementName);\n                            const cls = el.getAttribute(\"class\");\n                            el.setAttribute(\"class\", `${cls ? (cls + \" \") : \"\"}${elementName}_R2`);\n                            // TODO: strictly-speaking, this is a read-only property!\n                            (el as any).tagName =\n                                ((elementName === \"dtbook\") ? \"html\" :\n                                    ((elementName === \"book\") ? \"body\" :\n                                        ((elementName === \"pagenum\") ? \"span\" :\n                                            ((elementName === \"sent\") ? \"span\" :\n                                                ((elementName === \"caption\") ? \"figcaption\" :\n                                                    ((elementName === \"imggroup\") ? \"figure\" :\n                                                        \"div\"))))));\n                        }\n                    }\n\n                    // <?xml-stylesheet type=\"text/css\" href=\"dtbookbasic.css\"?>\n                    const stylesheets =\n                        select(\"/processing-instruction('xml-stylesheet')\", dtBookDoc) as ProcessingInstruction[];\n                    const cssHrefs: string[] = []; // `<link rel=\"stylesheet\" href=\"${cssHref}\" />`\n                    for (const stylesheet of stylesheets) {\n                        if (!stylesheet.nodeValue) {\n                            continue;\n                        }\n                        if (!stylesheet.nodeValue.includes(\"text/css\")) {\n                            continue;\n                        }\n                        const match = stylesheet.nodeValue.match(/href=(\"|')(.*?)(\"|')/);\n                        if (!match) {\n                            continue;\n                        }\n                        const href = match[2].trim();\n                        if (href) {\n                            cssHrefs.push(href);\n                        }\n                    }\n\n                    const smilRefs = select(\"//*[@smilref]\", dtBookDoc) as Element[];\n                    for (const smilRef of smilRefs) {\n                        const ref = smilRef.getAttribute(\"smilref\");\n                        if (ref) {\n                            smilRef.setAttribute(\"data-smilref\", ref);\n                        }\n                        smilRef.removeAttribute(\"smilref\");\n                    }\n\n                    // does not work (element renamed via the tagName assignment still have the original NameSpaceURI,\n                    // which gets serialized)\n                    // dtBookDoc.documentElement.setAttribute(\"xmlns\", \"http://www.w3.org/1999/xhtml\");\n\n                    // does not work (read only property):\n                    // (dtBookDoc as any).doctype = null;\n                    // ...so we use regexp replace below\n\n                    const dtbookNowXHTML = new xmldom.XMLSerializer().serializeToString(dtBookDoc)\n                        .replace(/xmlns=\"http:\\/\\/www\\.daisy\\.org\\/z3986\\/2005\\/dtbook\\/\"/, \"xmlns=\\\"http://www.w3.org/1999/xhtml\\\"\")\n                        .replace(/^([\\s\\S]*)<html/gm,\n                            `<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<!DOCTYPE xhtml>\n<html`)\n                        .replace(/<head([\\s\\S]*?)>/gm,\n                            `\n<head$1>\n<meta charset=\"UTF-8\" />\n<title>${title ? title : \" \"}</title>\n`)\n                        .replace(/<\\/head[\\s\\S]*?>/gm,\n                            `\n${cssHrefs.reduce((pv, cv) => {\n                                return pv + \"\\n\" + `<link rel=\"stylesheet\" type=\"text/css\" href=\"${cv}\" />`;\n                            }, \"\")}\n</head>\n`);\n                    const xhtmlFilePath = resLink.HrefDecoded.replace(/\\.(.+)$/, \".xhtml\");\n\n                    // const xhtmlOutputFilePath = path.join(outputDirPathExploded, xhtmlFilePath);\n                    // ensureDirs(xhtmlOutputFilePath);\n                    // fs.writeFileSync(xhtmlOutputFilePath, dtbookNowXHTML);\n                    // zipfile.addFile(xhtmlOutputFilePath, xhtmlFilePath);\n                    zipfile.addBuffer(Buffer.from(dtbookNowXHTML), xhtmlFilePath);\n\n                    const resLinkJson = TaJsonSerialize(resLink);\n                    // resLinkJson.href = xhtmlFilePath;\n                    const resLinkClone = TaJsonDeserialize<Link>(resLinkJson, Link);\n                    resLinkClone.setHrefDecoded(xhtmlFilePath);\n                    resLinkClone.TypeLink = \"application/xhtml+xml\";\n\n                    publication.Spine.push(resLinkClone);\n\n                    if (combinedMediaOverlays && publication.Spine.length === 1) {\n                        resLinkClone.MediaOverlays = combinedMediaOverlays;\n\n                        if (combinedMediaOverlays.duration) {\n                            resLinkClone.Duration = combinedMediaOverlays.duration;\n                        }\n\n                        const moURL = \"smil-media-overlays.json\";\n                        // mediaOverlayURLPath + \"?\" +\n                        //     mediaOverlayURLParam + \"=\" +\n                        //     encodeURIComponent_RFC3986(\n                        //         resLinkClone.HrefDecoded ? resLinkClone.HrefDecoded : resLinkClone.Href);\n\n                        // legacy method:\n                        if (!resLinkClone.Properties) {\n                            resLinkClone.Properties = new Properties();\n                        }\n                        resLinkClone.Properties.MediaOverlay = moURL;\n\n                        // new method:\n                        // https://w3c.github.io/sync-media-pub/incorporating-synchronized-narration.html#with-webpub\n                        if (!resLinkClone.Alternate) {\n                            resLinkClone.Alternate = [];\n                        }\n                        const moLink = new Link();\n                        moLink.Href = moURL;\n                        moLink.TypeLink = \"application/vnd.syncnarr+json\";\n                        moLink.Duration = resLinkClone.Duration;\n                        resLinkClone.Alternate.push(moLink);\n\n                        const jsonObjMO = TaJsonSerialize(combinedMediaOverlays);\n                        const jsonStrMO = global.JSON.stringify(jsonObjMO, null, \"  \");\n                        zipfile.addBuffer(Buffer.from(jsonStrMO), moURL);\n                    }\n\n                } else if (!resLink.HrefDecoded.endsWith(\".opf\") &&\n                    !resLink.HrefDecoded.endsWith(\".res\") &&\n                    !resLink.HrefDecoded.endsWith(\".ncx\")) {\n\n                    const buff = await loadFileBufferFromZipPath(resLink.Href, resLink.HrefDecoded, zip);\n                    if (buff) {\n                        zipfile.addBuffer(buff, resLink.HrefDecoded);\n                    }\n\n                    resourcesToKeep.push(resLink);\n                }\n            }\n\n            publication.Resources = resourcesToKeep;\n\n            if (!publication.Metadata) {\n                publication.Metadata = new Metadata();\n            }\n            // publication.Metadata.Source = \"DAISY\";\n            if (!publication.Metadata.AdditionalJSON) {\n                publication.Metadata.AdditionalJSON = {};\n            }\n            publication.Metadata.AdditionalJSON.ReadiumWebPublicationConvertedFrom = \"DAISY\";\n\n            const findFirstDescendantText = (parent: Element): Element | undefined => {\n                if (parent.childNodes && parent.childNodes.length) {\n                    // tslint:disable-next-line: prefer-for-of\n                    for (let i = 0; i < parent.childNodes.length; i++) {\n                        const child = parent.childNodes[i];\n                        if (child.nodeType === 1) { // Node.ELEMENT_NODE\n                            const element = child as Element;\n                            if (element.localName && element.localName.toLowerCase() === \"text\") {\n                                return element;\n                            }\n                        }\n                    }\n                    // tslint:disable-next-line: prefer-for-of\n                    for (let i = 0; i < parent.childNodes.length; i++) {\n                        const child = parent.childNodes[i];\n                        if (child.nodeType === 1) { // Node.ELEMENT_NODE\n                            const element = child as Element;\n                            const found = findFirstDescendantText(element);\n                            if (found) {\n                                return found;\n                            }\n                        }\n                    }\n                }\n                return undefined;\n            };\n\n            const smilDocs: Record<string, Document> = {};\n\n            const processLink = async (link: Link) => {\n                // relative to publication root (package.opf / ReadiumWebPubManifest.json)\n                let href = link.HrefDecoded;\n                if (!href) {\n                    return;\n                }\n\n                let fragment: string | undefined;\n                if (href.indexOf(\"#\") >= 0) {\n                    const arr = href.split(\"#\");\n                    href = arr[0].trim();\n                    fragment = arr[1].trim();\n                }\n                if (!href) {\n                    return;\n                }\n\n                let smilDoc = smilDocs[href];\n                if (!smilDoc) {\n                    const smilStr = await loadFileStrFromZipPath(href, href, zip);\n                    if (!smilStr) {\n                        debug(\"!loadFileStrFromZipPath\", smilStr);\n                        return;\n                    }\n                    smilDoc = new xmldom.DOMParser().parseFromString(smilStr, \"application/xml\");\n                    smilDocs[href] = smilDoc;\n                }\n\n                let targetEl = fragment ? smilDoc.getElementById(fragment) as Element : undefined;\n                if (!targetEl) {\n                    // const textElems = smilDoc.getElementsByTagName(\"text\");\n                    // if (textElems && textElems[0]) {\n                    //     targetEl = textElems[0];\n                    // }\n                    targetEl = findFirstDescendantText(smilDoc.documentElement);\n                }\n                if (!targetEl) {\n                    return;\n                }\n                if (targetEl.nodeName !== \"text\") {\n                    // const textElems = select(\"//text\", targetEl, true) as Element;\n                    // if (textElems) {\n                    //     targetEl = textElems;\n                    // }\n                    targetEl = findFirstDescendantText(targetEl);\n                }\n                if (!targetEl || targetEl.nodeName !== \"text\") {\n                    return;\n                }\n\n                const src = targetEl.getAttribute(\"src\");\n                if (!src) {\n                    return;\n                }\n                // TODO: path is relative to SMIL (not to publication root),\n                // and .xml file extension replacement is bit weak / brittle\n                // (but for most DAISY books, this is a reasonable expectation)\n                link.Href = src.replace(/\\.xml/, \".xhtml\");\n            };\n\n            const processLinks = async (links: Link[]) => {\n                for (const link of links) {\n                    await processLink(link);\n                    if (link.Children) {\n                        await processLinks(link.Children);\n                    }\n                }\n            };\n\n            if (publication.PageList) {\n                for (const link of publication.PageList) {\n                    await processLink(link);\n                }\n            }\n\n            if (publication.Landmarks) {\n                for (const link of publication.Landmarks) {\n                    await processLink(link);\n                }\n            }\n\n            if (publication.TOC) {\n                await processLinks(publication.TOC);\n            }\n\n            const jsonObj = TaJsonSerialize(publication);\n            const jsonStr = global.JSON.stringify(jsonObj, null, \"  \");\n            zipfile.addBuffer(Buffer.from(jsonStr), \"manifest.json\");\n        } catch (erreur) {\n            debug(erreur);\n        } finally {\n            timeoutId = setTimeout(() => {\n                timeoutId = undefined;\n                reject(\"YAZL zip took too long!? \" + outputZipPath);\n            }, 10000);\n            zipfile.end();\n        }\n    });\n};\n"]}