{"version":3,"file":"daisy-convert-ncc-to-opf-ncx.js","sourceRoot":"","sources":["../../../../src/parser/daisy-convert-ncc-to-opf-ncx.ts"],"names":[],"mappings":"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","sourcesContent":["// ==LICENSE-BEGIN==\n// Copyright 2017 European Digital Reading Lab. All rights reserved.\n// Licensed to the Readium Foundation under one or more contributor license agreements.\n// Use of this source code is governed by a BSD-style license\n// that can be found in the LICENSE file exposed on Github (readium) in the project repository.\n// ==LICENSE-END==\n\nimport * as debug_ from \"debug\";\nimport * as mime from \"mime-types\";\nimport * as path from \"path\";\nimport * as xmldom from \"xmldom\";\n\nimport { timeStrToSeconds } from \"@models/media-overlay\";\nimport { streamToBufferPromise } from \"@r2-utils-js/_utils/stream/BufferUtils\";\nimport { IStreamAndLength, IZip } from \"@r2-utils-js/_utils/zip/zip\";\n\nimport { zipHasEntry } from \"../_utils/zipHasEntry\";\nimport { getNcx_, getOpf_ } from \"./epub-daisy-common\"; // , loadFileStrFromZipPath\nimport { NCX } from \"./epub/ncx\";\nimport { OPF } from \"./epub/opf\";\n\nconst debug = debug_(\"r2:shared#parser/daisy-convert-to-epub\");\n\nconst getMediaTypeFromFileExtension = (ext: string) => {\n    if (/\\.smil$/i.test(ext)) {\n        return \"application/smil+xml\";\n    }\n\n    if (/\\.css$/i.test(ext)) {\n        return \"text/css\";\n    }\n\n    if (/\\.mp3$/i.test(ext)) {\n        return \"audio/mpeg\";\n    }\n\n    if (/\\.wav$/i.test(ext)) {\n        return \"audio/wav\";\n    }\n\n    if (/\\.jpe?g$/i.test(ext)) {\n        return \"image/jpeg\";\n    }\n\n    if (/\\.png$/i.test(ext)) {\n        return \"image/png\";\n    }\n\n    if (/\\.xml$/i.test(ext)) {\n        return \"application/x-dtbook+xml\";\n    }\n\n    if (/\\.html$/i.test(ext)) {\n        return \"text/html\";\n    }\n\n    if (/\\.xhtml$/i.test(ext)) {\n        return \"application/xhtml+xml\";\n    }\n\n    return mime.lookup(\"dummy\" + ext);\n};\n\nexport const convertNccToOpfAndNcx = async (\n    zip: IZip,\n    rootfilePathDecoded: string,\n    rootfilePath: string,\n): Promise<[OPF, NCX]> => {\n\n    const has = await zipHasEntry(zip, rootfilePathDecoded, rootfilePath);\n    if (!has) {\n        const err = `NOT IN ZIP (NCC.html): ${rootfilePath} --- ${rootfilePathDecoded}`;\n        debug(err);\n        const zipEntries = await zip.getEntries();\n        for (const zipEntry of zipEntries) {\n            if (zipEntry.startsWith(\"__MACOSX/\")) {\n                continue;\n            }\n            debug(zipEntry);\n        }\n        return Promise.reject(err);\n    }\n\n    let nccZipStream_: IStreamAndLength;\n    try {\n        nccZipStream_ = await zip.entryStreamPromise(rootfilePathDecoded);\n    } catch (err) {\n        debug(err);\n        return Promise.reject(err);\n    }\n    const nccZipStream = nccZipStream_.stream;\n\n    let nccZipData: Buffer;\n    try {\n        nccZipData = await streamToBufferPromise(nccZipStream);\n    } catch (err) {\n        debug(err);\n        return Promise.reject(err);\n    }\n\n    const nccStr = nccZipData.toString(\"utf8\");\n\n    const nccDoc = new xmldom.DOMParser().parseFromString(\n        nccStr,\n        \"application/xml\",\n        // \"text/html\",\n        // \"application/xhtml+xml\",\n    );\n\n    const metas = Array.from(nccDoc.getElementsByTagName(\"meta\")).\n        reduce((prevVal, curVal) => {\n            const name = curVal.getAttribute(\"name\");\n            const content = curVal.getAttribute(\"content\");\n            if (name && content) {\n                prevVal[name] = content;\n            }\n            return prevVal;\n        }, {} as {[key: string]: string});\n\n    const aElems = Array.from(nccDoc.getElementsByTagName(\"a\"));\n\n    // TODO: textPartAudio / audioPartText?? audioOnly??\n    // https://www.daisy.org/z3986/specifications/Z39-86-2002.html#Type\n    // https://www.daisy.org/z3986/specifications/daisy_202.html\n    let multimediaContent = \"\";\n    let multimediaType = \"\";\n    if (metas[\"ncc:multimediaType\"] === \"audioFullText\" ||\n        metas[\"ncc:multimediaType\"] === \"audioNcc\" ||\n        metas[\"ncc:totalTime\"] && timeStrToSeconds(metas[\"ncc:totalTime\"]) > 0) {\n        if (metas[\"ncc:multimediaType\"] === \"audioFullText\") {\n            multimediaContent = \"audio,text,image\";\n            multimediaType = \"audioFullText\";\n        } else {\n            multimediaContent = \"audio,image\";\n            multimediaType = \"audioNCX\";\n        }\n    } else if (metas[\"ncc:multimediaType\"] === \"textNcc\" ||\n        metas[\"ncc:totalTime\"] && timeStrToSeconds(metas[\"ncc:totalTime\"]) === 0) {\n        multimediaContent = \"text,image\";\n        multimediaType = \"textNCX\";\n    }\n\n    const zipEntriez = (await zip.getEntries()).filter((e) => {\n        return e && !e.endsWith(\"/\"); // exclude folders!\n    });\n\n    const manifestItemsBaseStr = zipEntriez.reduce((pv, cv, ci) => {\n        const ext = path.extname(cv);\n        return `${pv}${!cv.startsWith(\"__MACOSX/\") && !/ncc\\.html$/i.test(cv) && !/\\.ent$/i.test(ext) && !/\\.dtd$/i.test(ext) && !/\\.smil$/i.test(ext) ? `\n        <item\n            href=\"${path.relative(\"file:///\" + path.dirname(rootfilePathDecoded), \"file:///\" + cv).replace(/\\\\/g, \"/\")}\"\n            id=\"opf-zip-${ci}\"\n            media-type=\"${getMediaTypeFromFileExtension(ext)}\" />` : \"\"}`;\n    }, \"\");\n    const arrSmils: string[] = [];\n    const manifestItemsStr = aElems.reduce((pv, cv, _ci) => {\n        const href = cv.getAttribute(\"href\");\n        if (!href) {\n            return pv;\n        }\n        if (!/\\.smil(#.*)?$/i.test(href)) {\n            return pv;\n        }\n\n        const smil = href.replace(/(.+\\.smil)(#.*)?$/i, \"$1\");\n        if (arrSmils.indexOf(smil) >= 0) {\n            return pv;\n        }\n        arrSmils.push(smil);\n\n        // const txt = cv.textContent ? cv.textContent.trim() : \"\";\n\n        return `${pv}${`\n            <item\n                href=\"${smil}\"\n                id=\"opf-ncc-${arrSmils.length - 1}\"\n                media-type=\"application/smil+xml\" />`}`;\n    }, manifestItemsBaseStr);\n\n    const spineItemsStr = arrSmils.reduce((pv, _cv, ci) => {\n        return `${pv}${`\n            <itemref idref=\"opf-ncc-${ci}\" />`}`;\n    }, \"\");\n\n    let playOrder = 0;\n    let pCount = 0;\n    const pageListStr = aElems.reduce((pv, cv, _ci) => {\n        const href = cv.getAttribute(\"href\");\n        if (!href) {\n            return pv;\n        }\n        if (!/\\.smil(#.*)?$/i.test(href)) {\n            return pv;\n        }\n        if (!cv.parentNode) {\n            return pv;\n        }\n        playOrder++;\n\n        const clazz = (cv.parentNode as Element).getAttribute(\"class\");\n        if (!clazz || !clazz.startsWith(\"page\")) {\n            return pv;\n        }\n\n        const txt = cv.textContent ? cv.textContent.trim() : \"\";\n\n        pCount++;\n        return `${pv}${`\n<pageTarget class=\"pagenum\" id=\"ncx-p${pCount}\" playOrder=\"${playOrder}\" type=\"normal\" value=\"${pCount}\">\n<navLabel>\n<text>${txt ? txt : pCount}</text>\n</navLabel>\n<content src=\"${href}\"/>\n</pageTarget>\n`}`;\n    }, \"\");\n\n    playOrder = 0;\n    pCount = 0;\n    const navMapStr = aElems.reduce((pv, cv, _ci) => {\n        const href = cv.getAttribute(\"href\");\n        if (!href) {\n            return pv;\n        }\n        if (!/\\.smil(#.*)?$/i.test(href)) {\n            return pv;\n        }\n        if (!cv.parentNode) {\n            return pv;\n        }\n        playOrder++;\n\n        const name = (cv.parentNode as Element).localName;\n        if (!name || !name.startsWith(\"h\")) {\n            return pv;\n        }\n        const level = parseInt(name.substr(1), 10);\n\n        const txt = cv.textContent ? cv.textContent.trim() : \"\";\n\n        pCount++;\n\n        const inner = `<!-- h${level-1}_${pCount-1} -->`;\n        if (pv.indexOf(inner) >= 0) {\n            return pv.replace(inner, `\n<navPoint class=\"${name}\" id=\"ncx-t${pCount}\" playOrder=\"${playOrder}\">\n<navLabel>\n<text>${txt ? txt : `_${pCount}`}</text>\n</navLabel>\n<content src=\"${href}\"/>\n<!-- ${name}_${pCount} -->\n</navPoint>\n<!-- h${level-1}_${pCount} -->\n`);\n        } else {\n            return `${pv}${`\n<navPoint class=\"${name}\" id=\"ncx-t${pCount}\" playOrder=\"${playOrder}\">\n<navLabel>\n<text>${txt ? txt : `_${pCount}`}</text>\n</navLabel>\n<content src=\"${href}\"/>\n<!-- ${name}_${pCount} -->\n</navPoint>\n`}`;\n        }\n    }, \"\");\n\n    const opfStr = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE package\nPUBLIC \"+//ISBN 0-9673008-1-9//DTD OEB 1.2 Package//EN\"\n\"http://openebook.org/dtds/oeb-1.2/oebpkg12.dtd\">\n<package xmlns=\"http://openebook.org/namespaces/oeb-package/1.0/\" unique-identifier=\"uid\">\n\n<metadata>\n<dc-metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\"\nxmlns:oebpackage=\"http://openebook.org/namespaces/oeb-package/1.0/\">\n    <dc:Format>ANSI/NISO Z39.86-2005</dc:Format>\n    ${metas[\"dc:date\"] ? `<dc:Date>${metas[\"dc:date\"]}</dc:Date>` : \"\"}\n    ${metas[\"dc:language\"] ? `<dc:Language>${metas[\"dc:language\"]}</dc:Language>` : \"\"}\n    ${metas[\"dc:creator\"] ? `<dc:Creator>${metas[\"dc:creator\"]}</dc:Creator>` : \"\"}\n    ${metas[\"dc:publisher\"] ? `<dc:Publisher>${metas[\"dc:publisher\"]}</dc:Publisher>` : \"\"}\n    ${metas[\"dc:title\"] ? `<dc:Title>${metas[\"dc:title\"]}</dc:Title>` : \"\"}\n    ${metas[\"dc:identifier\"] ? `<dc:Identifier id=\"uid\">${metas[\"dc:identifier\"]}</dc:Identifier>` : \"\"}\n</dc-metadata>\n\n<x-metadata>\n    ${metas[\"ncc:narrator\"] ? `<meta name=\"dtb:narrator\" content=\"${metas[\"ncc:narrator\"]}\" />` : \"\"}\n    ${metas[\"ncc:totalTime\"] ? `<meta name=\"dtb:totalTime\" content=\"${metas[\"ncc:totalTime\"]}\" />` : \"\"}\n\n    <meta name=\"dtb:multimediaType\" content=\"${multimediaType}\" />\n    <meta name=\"dtb:multimediaContent\" content=\"${multimediaContent}\" />\n\n    <!-- RAW COPY FROM DAISY2: -->\n    ${Object.keys(metas).reduce((pv, cv) => {\n        return `${pv}\n    <meta name=\"${cv}\" content=\"${metas[cv]}\" />`;\n    }, \"\")}\n</x-metadata>\n\n</metadata>\n\n<manifest>\n<!-- item href=\"package.opf\" id=\"opf\" media-type=\"text/xml\" />\n<item href=\"navigation.ncx\" id=\"ncx\" media-type=\"application/x-dtbncx+xml\" / -->\n\n${manifestItemsStr}\n</manifest>\n\n<spine>\n${spineItemsStr}\n</spine>\n\n</package>`;\n\n    // debug(opfStr);\n    // if (process.env) {\n    //     throw new Error(\"BREAK\");\n    // }\n\n    const opf = getOpf_(opfStr, rootfilePathDecoded);\n\n    const ncxStr = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<ncx xmlns=\"http://www.daisy.org/z3986/2005/ncx/\" version=\"2005-1\">\n<head>\n    ${metas[\"dc:identifier\"] ? `<meta name=\"dtb:uid\" content=\"${metas[\"dc:identifier\"]}\" />` : \"\"}\n    ${metas[\"ncc:generator\"] ? `<meta name=\"dtb:generator\" content=\"${metas[\"ncc:generator\"]}\"/>` : \"\"}\n    ${metas[\"ncc:depth\"] ? `<meta name=\"dtb:depth\" content=\"${metas[\"ncc:depth\"]}\"/>` : \"\"}\n    ${metas[\"ncc:pageNormal\"] ? `<meta name=\"dtb:totalPageCount\" content=\"${metas[\"ncc:pageNormal\"]}\"/>` : \"\"}\n    ${metas[\"ncc:maxPageNormal\"] ? `<meta name=\"dtb:maxPageNumber\" content=\"${metas[\"ncc:maxPageNormal\"]}\"/>` : \"\"}\n</head>\n\n<docTitle>\n<text>${metas[\"dc:title\"] ? metas[\"dc:title\"] : \"_\"}</text>\n</docTitle>\n\n<docAuthor>\n<text>${metas[\"dc:creator\"] ? metas[\"dc:creator\"] : \"-\"}</text>\n</docAuthor>\n\n<navMap id=\"navMap\">\n${navMapStr}\n</navMap>\n\n<pageList id=\"pageList\">\n${pageListStr}\n</pageList>\n\n</ncx>`;\n\n    // debug(ncxStr);\n    // if (process.env) {\n    //     throw new Error(\"BREAK\");\n    // }\n\n    const ncx = getNcx_(ncxStr, rootfilePathDecoded);\n\n    return [opf, ncx];\n};\n\n"]}