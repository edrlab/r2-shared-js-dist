{"version":3,"file":"daisy-convert-ncc-to-opf-ncx.js","sourceRoot":"","sources":["../../../../src/parser/daisy-convert-ncc-to-opf-ncx.ts"],"names":[],"mappings":"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","sourcesContent":["// ==LICENSE-BEGIN==\n// Copyright 2017 European Digital Reading Lab. All rights reserved.\n// Licensed to the Readium Foundation under one or more contributor license agreements.\n// Use of this source code is governed by a BSD-style license\n// that can be found in the LICENSE file exposed on Github (readium) in the project repository.\n// ==LICENSE-END==\n\nimport * as debug_ from \"debug\";\nimport * as mime from \"mime-types\";\nimport * as path from \"path\";\nimport * as xmldom from \"@xmldom/xmldom\";\n\nimport { timeStrToSeconds } from \"@models/media-overlay\";\nimport { streamToBufferPromise } from \"@r2-utils-js/_utils/stream/BufferUtils\";\nimport { IStreamAndLength, IZip } from \"@r2-utils-js/_utils/zip/zip\";\n\nimport { zipHasEntry } from \"../_utils/zipHasEntry\";\nimport { getNcx_, getOpf_ } from \"./epub-daisy-common\"; // , loadFileStrFromZipPath\nimport { NCX } from \"./epub/ncx\";\nimport { OPF } from \"./epub/opf\";\n\nconst debug = debug_(\"r2:shared#parser/daisy-convert-to-epub\");\n\nconst getMediaTypeFromFileExtension = (ext: string) => {\n    if (/\\.smil$/i.test(ext)) {\n        return \"application/smil+xml\";\n    }\n\n    if (/\\.css$/i.test(ext)) {\n        return \"text/css\";\n    }\n\n    if (/\\.mp3$/i.test(ext)) {\n        return \"audio/mpeg\";\n    }\n\n    if (/\\.wav$/i.test(ext)) {\n        return \"audio/wav\";\n    }\n\n    if (/\\.jpe?g$/i.test(ext)) {\n        return \"image/jpeg\";\n    }\n\n    if (/\\.png$/i.test(ext)) {\n        return \"image/png\";\n    }\n\n    if (/\\.xml$/i.test(ext)) {\n        return \"application/x-dtbook+xml\";\n    }\n\n    if (/\\.html$/i.test(ext)) {\n        return \"text/html\";\n    }\n\n    if (/\\.xhtml$/i.test(ext)) {\n        return \"application/xhtml+xml\";\n    }\n\n    return mime.lookup(\"dummy\" + ext);\n};\n\nexport const convertNccToOpfAndNcx = async (\n    zip: IZip,\n    rootfilePathDecoded: string,\n    rootfilePath: string,\n): Promise<[OPF, NCX]> => {\n\n    const has = await zipHasEntry(zip, rootfilePathDecoded, rootfilePath);\n    if (!has) {\n        const err = `NOT IN ZIP (NCC.html): ${rootfilePath} --- ${rootfilePathDecoded}`;\n        debug(err);\n        const zipEntries = await zip.getEntries();\n        for (const zipEntry of zipEntries) {\n            if (zipEntry.startsWith(\"__MACOSX/\")) {\n                continue;\n            }\n            debug(zipEntry);\n        }\n        return Promise.reject(err);\n    }\n\n    let nccZipStream_: IStreamAndLength;\n    try {\n        nccZipStream_ = await zip.entryStreamPromise(rootfilePathDecoded);\n    } catch (err) {\n        debug(err);\n        return Promise.reject(err);\n    }\n    const nccZipStream = nccZipStream_.stream;\n\n    let nccZipData: Buffer;\n    try {\n        nccZipData = await streamToBufferPromise(nccZipStream);\n    } catch (err) {\n        debug(err);\n        return Promise.reject(err);\n    }\n\n    const nccStr = nccZipData.toString(\"utf8\");\n\n    const nccDoc = new xmldom.DOMParser().parseFromString(\n        nccStr,\n        \"application/xml\",\n        // \"text/html\",\n        // \"application/xhtml+xml\",\n    );\n\n    const metas = Array.from(nccDoc.getElementsByTagName(\"meta\")).\n        reduce((prevVal, curVal) => {\n            const name = curVal.getAttribute(\"name\");\n            const content = curVal.getAttribute(\"content\");\n            if (name && content) {\n                prevVal[name] = content;\n            }\n            return prevVal;\n        }, {} as {[key: string]: string});\n\n    const aElems = Array.from(nccDoc.getElementsByTagName(\"a\"));\n\n    // TODO: textPartAudio / audioPartText?? audioOnly??\n    // https://www.daisy.org/z3986/specifications/Z39-86-2002.html#Type\n    // https://www.daisy.org/z3986/specifications/daisy_202.html\n    let multimediaContent = \"\";\n    let multimediaType = \"\";\n    if (metas[\"ncc:multimediaType\"] === \"audioFullText\" ||\n        metas[\"ncc:multimediaType\"] === \"audioNcc\" ||\n        metas[\"ncc:totalTime\"] && timeStrToSeconds(metas[\"ncc:totalTime\"]) > 0) {\n        if (metas[\"ncc:multimediaType\"] === \"audioFullText\") {\n            multimediaContent = \"audio,text,image\";\n            multimediaType = \"audioFullText\";\n        } else {\n            multimediaContent = \"audio,image\";\n            multimediaType = \"audioNCX\";\n        }\n    } else if (metas[\"ncc:multimediaType\"] === \"textNcc\" ||\n        metas[\"ncc:totalTime\"] && timeStrToSeconds(metas[\"ncc:totalTime\"]) === 0) {\n        multimediaContent = \"text,image\";\n        multimediaType = \"textNCX\";\n    }\n\n    const zipEntriez = (await zip.getEntries()).filter((e) => {\n        return e && !e.endsWith(\"/\"); // exclude folders!\n    });\n\n    const manifestItemsBaseStr = zipEntriez.reduce((pv, cv, ci) => {\n        const ext = path.extname(cv);\n        return `${pv}${!cv.startsWith(\"__MACOSX/\") && !/ncc\\.html$/i.test(cv) && !/\\.ent$/i.test(ext) && !/\\.dtd$/i.test(ext) && !/\\.smil$/i.test(ext) ? `\n        <item\n            href=\"${path.relative(\"file:///\" + path.dirname(rootfilePathDecoded), \"file:///\" + cv).replace(/\\\\/g, \"/\")}\"\n            id=\"opf-zip-${ci}\"\n            media-type=\"${getMediaTypeFromFileExtension(ext)}\" />` : \"\"}`;\n    }, \"\");\n    const arrSmils: string[] = [];\n    const manifestItemsStr = aElems.reduce((pv, cv, _ci) => {\n        const href = cv.getAttribute(\"href\");\n        if (!href) {\n            return pv;\n        }\n        if (!/\\.smil(#.*)?$/i.test(href)) {\n            return pv;\n        }\n\n        const smil = href.replace(/(.+\\.smil)(#.*)?$/i, \"$1\");\n        if (arrSmils.indexOf(smil) >= 0) {\n            return pv;\n        }\n        arrSmils.push(smil);\n\n        // const txt = cv.textContent ? cv.textContent.trim() : \"\";\n\n        return `${pv}${`\n            <item\n                href=\"${smil}\"\n                id=\"opf-ncc-${arrSmils.length - 1}\"\n                media-type=\"application/smil+xml\" />`}`;\n    }, manifestItemsBaseStr);\n\n    const spineItemsStr = arrSmils.reduce((pv, _cv, ci) => {\n        return `${pv}${`\n            <itemref idref=\"opf-ncc-${ci}\" />`}`;\n    }, \"\");\n\n    let playOrder = 0;\n    let pCount = 0;\n    const pageListStr = aElems.reduce((pv, cv, _ci) => {\n        const href = cv.getAttribute(\"href\");\n        if (!href) {\n            return pv;\n        }\n        if (!/\\.smil(#.*)?$/i.test(href)) {\n            return pv;\n        }\n        if (!cv.parentNode) {\n            return pv;\n        }\n        playOrder++;\n\n        const clazz = (cv.parentNode as Element).getAttribute(\"class\");\n        if (!clazz || !clazz.startsWith(\"page\")) {\n            return pv;\n        }\n\n        const txt = cv.textContent ? cv.textContent.trim() : \"\";\n\n        pCount++;\n        return `${pv}${`\n<pageTarget class=\"pagenum\" id=\"ncx-p${pCount}\" playOrder=\"${playOrder}\" type=\"normal\" value=\"${pCount}\">\n<navLabel>\n<text>${txt ? txt : pCount}</text>\n</navLabel>\n<content src=\"${href}\"/>\n</pageTarget>\n`}`;\n    }, \"\");\n\n    playOrder = 0;\n    pCount = 0;\n    const navMapStr = aElems.reduce((pv, cv, _ci) => {\n        const href = cv.getAttribute(\"href\");\n        if (!href) {\n            return pv;\n        }\n        if (!/\\.smil(#.*)?$/i.test(href)) {\n            return pv;\n        }\n        if (!cv.parentNode) {\n            return pv;\n        }\n        playOrder++;\n\n        const name = (cv.parentNode as Element).localName;\n        if (!name || !name.startsWith(\"h\")) {\n            return pv;\n        }\n        const level = parseInt(name.substr(1), 10);\n\n        const txt = cv.textContent ? cv.textContent.trim() : \"\";\n\n        pCount++;\n\n        const inner = `<!-- h${level-1}_${pCount-1} -->`;\n        if (pv.indexOf(inner) >= 0) {\n            return pv.replace(inner, `\n<navPoint class=\"${name}\" id=\"ncx-t${pCount}\" playOrder=\"${playOrder}\">\n<navLabel>\n<text>${txt ? txt : `_${pCount}`}</text>\n</navLabel>\n<content src=\"${href}\"/>\n<!-- ${name}_${pCount} -->\n</navPoint>\n<!-- h${level-1}_${pCount} -->\n`);\n        } else {\n            return `${pv}${`\n<navPoint class=\"${name}\" id=\"ncx-t${pCount}\" playOrder=\"${playOrder}\">\n<navLabel>\n<text>${txt ? txt : `_${pCount}`}</text>\n</navLabel>\n<content src=\"${href}\"/>\n<!-- ${name}_${pCount} -->\n</navPoint>\n`}`;\n        }\n    }, \"\");\n\n    const opfStr = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE package\nPUBLIC \"+//ISBN 0-9673008-1-9//DTD OEB 1.2 Package//EN\"\n\"http://openebook.org/dtds/oeb-1.2/oebpkg12.dtd\">\n<package xmlns=\"http://openebook.org/namespaces/oeb-package/1.0/\" unique-identifier=\"uid\">\n\n<metadata>\n<dc-metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\"\nxmlns:oebpackage=\"http://openebook.org/namespaces/oeb-package/1.0/\">\n    <dc:Format>ANSI/NISO Z39.86-2005</dc:Format>\n    ${metas[\"dc:date\"] ? `<dc:Date>${metas[\"dc:date\"]}</dc:Date>` : \"\"}\n    ${metas[\"dc:language\"] ? `<dc:Language>${metas[\"dc:language\"]}</dc:Language>` : \"\"}\n    ${metas[\"dc:creator\"] ? `<dc:Creator>${metas[\"dc:creator\"]}</dc:Creator>` : \"\"}\n    ${metas[\"dc:publisher\"] ? `<dc:Publisher>${metas[\"dc:publisher\"]}</dc:Publisher>` : \"\"}\n    ${metas[\"dc:title\"] ? `<dc:Title>${metas[\"dc:title\"]}</dc:Title>` : \"\"}\n    ${metas[\"dc:identifier\"] ? `<dc:Identifier id=\"uid\">${metas[\"dc:identifier\"]}</dc:Identifier>` : \"\"}\n</dc-metadata>\n\n<x-metadata>\n    ${metas[\"ncc:narrator\"] ? `<meta name=\"dtb:narrator\" content=\"${metas[\"ncc:narrator\"]}\" />` : \"\"}\n    ${metas[\"ncc:totalTime\"] ? `<meta name=\"dtb:totalTime\" content=\"${metas[\"ncc:totalTime\"]}\" />` : \"\"}\n\n    <meta name=\"dtb:multimediaType\" content=\"${multimediaType}\" />\n    <meta name=\"dtb:multimediaContent\" content=\"${multimediaContent}\" />\n\n    <!-- RAW COPY FROM DAISY2: -->\n    ${Object.keys(metas).reduce((pv, cv) => {\n        return `${pv}\n    <meta name=\"${cv}\" content=\"${metas[cv]}\" />`;\n    }, \"\")}\n</x-metadata>\n\n</metadata>\n\n<manifest>\n<!-- item href=\"package.opf\" id=\"opf\" media-type=\"text/xml\" />\n<item href=\"navigation.ncx\" id=\"ncx\" media-type=\"application/x-dtbncx+xml\" / -->\n\n${manifestItemsStr}\n</manifest>\n\n<spine>\n${spineItemsStr}\n</spine>\n\n</package>`;\n\n    // debug(opfStr);\n    // if (process.env) {\n    //     throw new Error(\"BREAK\");\n    // }\n\n    const opf = getOpf_(opfStr, rootfilePathDecoded);\n\n    const ncxStr = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<ncx xmlns=\"http://www.daisy.org/z3986/2005/ncx/\" version=\"2005-1\">\n<head>\n    ${metas[\"dc:identifier\"] ? `<meta name=\"dtb:uid\" content=\"${metas[\"dc:identifier\"]}\" />` : \"\"}\n    ${metas[\"ncc:generator\"] ? `<meta name=\"dtb:generator\" content=\"${metas[\"ncc:generator\"]}\"/>` : \"\"}\n    ${metas[\"ncc:depth\"] ? `<meta name=\"dtb:depth\" content=\"${metas[\"ncc:depth\"]}\"/>` : \"\"}\n    ${metas[\"ncc:pageNormal\"] ? `<meta name=\"dtb:totalPageCount\" content=\"${metas[\"ncc:pageNormal\"]}\"/>` : \"\"}\n    ${metas[\"ncc:maxPageNormal\"] ? `<meta name=\"dtb:maxPageNumber\" content=\"${metas[\"ncc:maxPageNormal\"]}\"/>` : \"\"}\n</head>\n\n<docTitle>\n<text>${metas[\"dc:title\"] ? metas[\"dc:title\"] : \"_\"}</text>\n</docTitle>\n\n<docAuthor>\n<text>${metas[\"dc:creator\"] ? metas[\"dc:creator\"] : \"-\"}</text>\n</docAuthor>\n\n<navMap id=\"navMap\">\n${navMapStr}\n</navMap>\n\n<pageList id=\"pageList\">\n${pageListStr}\n</pageList>\n\n</ncx>`;\n\n    // debug(ncxStr);\n    // if (process.env) {\n    //     throw new Error(\"BREAK\");\n    // }\n\n    const ncx = getNcx_(ncxStr, rootfilePathDecoded);\n\n    return [opf, ncx];\n};\n\n"]}